<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>DSA Learner ‚Äî Mastery Trainer</title>
    <link rel="icon" href="favicon.svg" type="image/svg+xml" />
    <link rel="stylesheet" href="styles.css" />
  </head>
  <body>
    <header class="app-header">
      <div class="brand">DSA Learner</div>
      <div class="header-actions">
        <button id="startPathBtn" class="ghost">Start Path</button>
        <button id="reviewQueueBtn" class="ghost">Review Queue</button>
        <button id="labBtn" class="ghost" title="Open DSA Lab">Lab</button>
        <button id="resetProgressBtn" class="danger ghost" title="Clear local progress">Reset</button>
      </div>
    </header>

    <div class="app">
      <aside class="sidebar" id="sidebar">
        <div style="padding: 10px; color: var(--text);">
          <div style="text-align: center; padding: 20px;">
            <div>üîÑ Loading topics...</div>
          </div>
        </div>
      </aside>
      <main class="main" id="main">
        <div style="padding: 20px; text-align: center; color: var(--text);">
          <h2>Welcome to DSA Learner</h2>
          <p>Loading content...</p>
        </div>
      </main>
      <aside class="coach" id="coach">
        <div style="padding: 10px; color: var(--text);">
          <h3>AI Coach</h3>
          <p>Initializing...</p>
        </div>
      </aside>
    </div>

    <footer class="footer">
      <div>Built for rapid, neuroscience-informed DSA mastery.</div>
      <div><a href="#" id="aboutLink">About</a></div>
    </footer>

    <div id="modal" class="modal hidden" role="dialog" aria-modal="true">
      <div class="modal-content">
        <div class="modal-header">
          <div id="modalTitle">Modal</div>
          <button id="modalClose" class="ghost">√ó</button>
        </div>
        <div id="modalBody" class="modal-body"></div>
      </div>
    </div>

    <!-- Load Pyodide after main content loads -->
    <script>
      // Delay Pyodide loading to not interfere with main app
      setTimeout(() => {
        const script = document.createElement('script');
        script.src = 'https://cdn.jsdelivr.net/pyodide/v0.24.1/full/pyodide.js';
        script.defer = true;
        document.head.appendChild(script);
      }, 2000);
    </script>
    
    <script defer src="tools/cpp_offline_stub.js"></script>
    <script type="module">
      // Add error handling and logging
      window.addEventListener('error', (e) => {
        console.error('Global error:', e.error);
        document.getElementById('main').innerHTML = '<div class="section"><h2>Error</h2><p>Failed to load: ' + e.error.message + '</p><p>Check console for details.</p></div>';
      });
      
      window.addEventListener('unhandledrejection', (e) => {
        console.error('Unhandled rejection:', e.reason);
        e.preventDefault();
      });
      
      // Load and initialize
      (async function() {
        try {
          console.log('üöÄ Starting DSA Learner initialization...');
          
          // Import modules with error handling
          const modules = await Promise.all([
            import('./src/modules/content.js').catch(e => { throw new Error('Failed to load content.js: ' + e.message); }),
            import('./src/modules/state.js').catch(e => { throw new Error('Failed to load state.js: ' + e.message); }),
            import('./src/modules/scheduler.js').catch(e => { throw new Error('Failed to load scheduler.js: ' + e.message); })
          ]);
          
          const { content } = modules[0];
          const { State } = modules[1];
          const { pickNextForReview, nextByDifficulty } = modules[2];
          
          console.log('‚úÖ Modules loaded successfully');
          console.log('üìö Content topics:', content.topics.length);
          
          // Load state
          const state = State.load();
          console.log('üíæ State loaded');
          
          // Get DOM elements
          const sidebar = document.getElementById('sidebar');
          const main = document.getElementById('main');
          const coach = document.getElementById('coach');
          const modal = document.getElementById('modal');
          const modalTitle = document.getElementById('modalTitle');
          const modalBody = document.getElementById('modalBody');
          const modalClose = document.getElementById('modalClose');
          
          // Modal functionality
          function openModal(title, bodyNode) {
            modalTitle.textContent = title;
            modalBody.innerHTML = '';
            if (bodyNode) modalBody.appendChild(bodyNode);
            modal.classList.remove('hidden');
          }
          modalClose.onclick = () => modal.classList.add('hidden');
          
          // Button handlers
          document.getElementById('resetProgressBtn').onclick = () => {
            if (confirm('Reset all local progress?')) {
              State.reset();
              location.reload();
            }
          };
          
          document.getElementById('reviewQueueBtn').onclick = () => {
            const next = pickNextForReview(state, content);
            if (!next) {
              alert('Review queue is empty. Do a Learn/Practice first!');
              return;
            }
            navigateTo(next.topicId, next.itemId, next.mode);
          };
          
          // Render functions
          function renderSidebar() {
            sidebar.innerHTML = '';
            const list = document.createElement('div');
            list.className = 'list';
            
            content.topics.forEach(t => {
              const box = document.createElement('div');
              box.className = 'topic';
              box.style.cursor = 'pointer';
              const pct = Math.round((state.progress[t.id] ? 10 : 0));
              box.innerHTML = \`
                <div class="row">
                  <div><strong>\${t.title}</strong></div>
                  <div class="progress-badge">\${pct}%</div>
                </div>
                <div class="muted" style="font-size: 12px; margin-top: 4px;">\${t.summary}</div>
                <div style="font-size: 11px; color: var(--muted); margin-top: 4px;">
                  \${t.items.length} items
                </div>
              \`;
              box.onclick = () => renderTopic(t.id);
              list.appendChild(box);
            });
            
            sidebar.appendChild(list);
            console.log('üìã Sidebar rendered with', content.topics.length, 'topics');
          }
          
          function renderTopic(topicId) {
            const topic = content.topics.find(t => t.id === topicId);
            if (!topic) return;
            
            console.log('üéØ Rendering topic:', topic.title);
            
            main.innerHTML = '';
            
            const header = document.createElement('div');
            header.className = 'section';
            header.innerHTML = \`
              <h2>\${topic.title}</h2>
              <div class="muted">\${topic.summary}</div>
              <div style="margin-top: 12px;">
                <span style="background: var(--elev); padding: 4px 8px; border-radius: 4px; font-size: 14px;">
                  \${topic.items.length} items
                </span>
              </div>
            \`;
            main.appendChild(header);
            
            const items = document.createElement('div');
            items.className = 'grid cols-2';
            items.style.gap = '12px';
            items.style.marginTop = '20px';
            
            topic.items.forEach(item => {
              const card = document.createElement('div');
              card.className = 'section';
              card.style.cursor = 'pointer';
              card.style.transition = 'border-color 0.2s';
              
              const difficultyColor = {
                'easy': 'var(--ok)',
                'medium': 'var(--warn)', 
                'hard': 'var(--danger)'
              }[item.difficulty] || 'var(--muted)';
              
              card.innerHTML = \`
                <div style="margin-bottom: 8px;">
                  <div style="font-weight: 600; margin-bottom: 4px;">\${item.title}</div>
                  <div style="font-size: 13px; color: var(--muted); line-height: 1.4;">
                    \${item.brief}
                  </div>
                </div>
                <div style="display: flex; justify-content: space-between; align-items: center;">
                  <span style="background: \${difficultyColor}; color: var(--bg); padding: 2px 6px; border-radius: 3px; font-size: 11px; font-weight: 500;">
                    \${item.difficulty || 'N/A'}
                  </span>
                  <span style="font-size: 11px; color: var(--muted);">
                    Click to start
                  </span>
                </div>
              \`;
              
              card.onmouseenter = () => card.style.borderColor = 'var(--accent)';
              card.onmouseleave = () => card.style.borderColor = 'var(--border)';
              card.onclick = () => {
                console.log('üéÆ Starting item:', item.title);
                alert('Item: ' + item.title + '\\n\\nThis would open the learning interface.\\n\\nImplementation: Load the specific learning module for this item.');
              };
              
              items.appendChild(card);
            });
            
            main.appendChild(items);
          }
          
          function renderCoach() {
            coach.innerHTML = \`
              <div class="section">
                <h3>ü§ñ AI Coach</h3>
                <p style="font-size: 14px; color: var(--muted); line-height: 1.4;">
                  Ready to help you master data structures and algorithms! 
                </p>
                <p style="font-size: 13px; color: var(--muted);">
                  Select a topic from the sidebar to begin your learning journey.
                </p>
              </div>
              <div class="section">
                <h4>Quick Stats</h4>
                <div style="font-size: 13px;">
                  <div>üìö Topics: \${content.topics.length}</div>
                  <div>üìù Total Items: \${content.topics.reduce((sum, t) => sum + t.items.length, 0)}</div>
                  <div>üéØ Progress: 0%</div>
                </div>
              </div>
            \`;
          }
          
          // Initialize everything
          renderSidebar();
          renderCoach();
          
          // Default to first topic
          if (content.topics.length > 0) {
            renderTopic(content.topics[0].id);
          }
          
          console.log('üéâ DSA Learner fully loaded!');
          
        } catch (error) {
          console.error('üí• Fatal error during initialization:', error);
          document.getElementById('main').innerHTML = \`
            <div class="section">
              <h2>‚ùå Loading Error</h2>
              <p>Failed to load DSA Learner:</p>
              <pre style="background: var(--code); padding: 10px; border-radius: 4px; overflow-x: auto; font-size: 12px;">\${error.message}</pre>
              <p style="font-size: 14px; color: var(--muted);">Check the browser console for more details.</p>
            </div>
          \`;
        }
      })();
    </script>
  </body>
</html>